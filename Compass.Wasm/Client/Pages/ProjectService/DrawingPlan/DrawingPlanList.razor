@page "/drawingplan"
@using Compass.Wasm.Shared.ProjectService

@inject HttpClient Http

<PageTitle>Drawing Plan</PageTitle>

<div class="row position-relative">
    <div class="col">
        <p>
            @if (projectsCountNotPlanned != 0)
            {
                @*todo:控制权限*@
                <AuthorizeView Roles="admin,pm">
                    <Authorized>
                        <a href="/adddrawingplan" class="me-2" style="color: red">添加计划</a>
                    </Authorized>
                </AuthorizeView>
                <span>未计划项目</span>
                <span class="badge   rounded-pill @(projectsCountNotPlanned == 0 ? "bg-success" : "bg-danger")">@projectsCountNotPlanned</span>
            }

            <span class="badge bg-secondary rounded-pill">生产周期=发货日期-发图日期</span>
            <span class="badge bg-success rounded-pill">日期已过</span>
            <span class="badge bg-warning text-black rounded-pill">正在进行</span>
            <span class="badge bg-black rounded-pill">缺少信息</span>
            <span class="badge bg-danger rounded-pill">存在问题</span>
        </p>
    </div>
    
</div>

@if (drawingsPlan==null)
{
    <p>制图计划加载中...</p>
}
else if (drawingsPlan.Length==0)
{
    <p>没有要显示的制图计划.</p>
}
else
{
    <div class="pt-1">
        @foreach (var drawingPlan in drawingsPlan)
        {
            <DrawingPlanTimeLine DrawingPlan="drawingPlan" />
        }
    </div>
}

@code {
    private DrawingPlanResponse[]? drawingsPlan;
    private int projectsCountNotPlanned;

    protected override async Task OnInitializedAsync()
    {
        projectsCountNotPlanned = (await Http.GetFromJsonAsync<ProjectResponse[]>("api/DrawingPlan/ProjectsNotPlanned"))!.Length;
        drawingsPlan=await Http.GetFromJsonAsync<DrawingPlanResponse[]>("api/DrawingPlan/All");
    }
}