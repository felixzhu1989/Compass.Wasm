@using Compass.Wasm.Shared.FileService
@inject HttpClient Http

<h3>测试上传单个文件</h3>
<InputFile class="form-control" OnChange="OnInputFileChange" />
<p>@resultUri</p>
<p>
    <a href="@resultUri" target="_blank">打开这个文件</a>
</p>

<button class="btn btn-primary" disabled="@(!isUploaded)">上传完成才能按该按钮</button>

@code
{
    
    //微软官方文档，Blazor上传文件
    //https://learn.microsoft.com/zh-cn/aspnet/core/blazor/file-uploads?view=aspnetcore-6.0&pivots=webassembly

    private string resultUri;
    private bool isUploaded;

    private async Task OnInputFileChange(InputFileChangeEventArgs e)
    {   
        isUploaded=false;
    //e.GetMultipleFiles();//获取多个文件
        var file = e.File;//一个文件
        
        using var content = new MultipartFormDataContent();
        content.Add(content: new StreamContent(file.OpenReadStream()),
            name: "\"files\"", fileName: file.Name);
        try
        {
            var response = await Http.PostAsync("api/Uploader", content);
            var uploadResponse = await response.Content
                .ReadFromJsonAsync<UploadResponse>();
            
            resultUri = uploadResponse.RemoteUrl.ToString();
            isUploaded = true;
        }
        catch (Exception ex)
        {
            isUploaded = false;
            resultUri =$"上传文件异常：{ex}";
        }
    }
}
